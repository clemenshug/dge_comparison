
```{r setup}
library(tidyverse)
library(synExtra)
library(readxl)
library(here)

synapser::synLogin()
syn <- synExtra::synDownloader("~/data/DGE_comp/")

wd <- here("wrangled")
```


```{r wrangling_funcs}
barcode_well_map <- syn("syn12979100") %>%
  read_xlsx(sheet = "barcodes_trugrade_384_set1")
  # rename(Barcode = barcode, Well = well, Plate_ID = plate_id)

prepare_barcode_counts <- function(barcode_count_file, barcode_map) {
  read_tsv(barcode_count_file, col_names = c("barcode", "count")) %>%
    mutate(
      barcode = str_replace(barcode, "^.*([ATCG]{6})$", "\\1")
    ) %>%
    left_join(
      barcode_well_map, by = "barcode"
    )
}

prepare_col_meta <- function(colmeta_file, barcode_map) {
  read_csv(colmeta_file, col_names = "barcode") %>%
    mutate(
      barcode = if (all(str_detect(barcode, fixed(":")))) str_split(barcode, fixed(":"), simplify = TRUE)[, 2] else barcode,
      col_idx = 1:n()
    ) %>%
    left_join(
      barcode_map %>%
        select(barcode, well),
      by = "barcode"
    )
}

prepare_row_meta <- function(rowmeta_file) {
  read_csv(rowmeta_file, col_names = "ensembl_gene_id") %>%
    mutate(row_idx = 1:n())
}

prepare_mtx_sparse <- function(mtx_file) {
  read_delim(
    mtx_file,
    delim = " ",
    skip = 3,
    col_names = c("row_idx", "col_idx", "count"),
    col_types = "iii"
  )
}

prepare_counts <- function(mtx, col_meta, row_meta, gene_mapping) {
  # browser()
  mtx %>%
    left_join(col_meta, by = "col_idx") %>%
    left_join(row_meta, by = "row_idx") %>%
    select(well, ensembl_gene_id, count) %>%
    inner_join(
      gene_mapping, by = "ensembl_gene_id"
    )
}

norm_drug <- function(x) {
  x %>%
    str_to_lower() %>%
    str_replace_all("[^a-zA-Z0-9]", "")
}

```

## John Santa Maria Merck drugs

Load and process RNA-seq data from John Santa Maria

John Santa Maria initiated a project looking at gene expression underlying phenotypic changes in intestinal myofibroblasts.

Cells were looked at for one time point at 3 drug doses in triplicate.  This was done either in the presence or absense of activating stimulus IL-1B.


-These cells were purchased from Lonza and originate from terminal fetuses. They are intestinal myofibroblasts.
-These are immunomodulatory drugs, most of which are public, save 2 which are private Merck compounds. All the data is jointly owned by Sorger and Merck, but the 2 private structures may be retained by the company (they also may not, as they are not of general interest).

- Sarah is in touch with Jon to get more details on the treatment of the cells.

Update 7_25_18

Primary human intestinal myofibroblasts were treated with a collection of tool compounds in dose series. The fibroblasts were treated with incubated with drugs for 24 hours. Then, either vehicle or 0.1 ng/mL IL-1B for 0, 1, or 6 hours before harvesting for DGE-Seq.


transfer.rc.hms.harvard.edu:/n/files/ImStor/sorger/data/rnaseq/lincs/DGE_fastq_files/cdk46_runs_batch2/170831_NS500422_0543_AHWKJLBGX2/

## Metadata

```{r jsm_meta}

jsm_meta_raw <- syn("syn21541012") %>%
  read_tsv()

jsm_meta <- jsm_meta_raw %>%
  transmute(
    plate = 1,
    well = str_replace(Well, "^([A-Z])([1-9])$", "\\10\\2"),
    cells = Cells,
    stim = recode(Stim, "0" = "control"),
    stim_conc = `StimConc(inng/mL)`,
    # Misspelled drug
    drug = recode(
      Drug,
      "0" = "control",
      "5Z-7-Oxozeanol" = "5Z-7-Oxozeaenol",
      "Nec-1s" = "CHEMBL381230",
      
    ),
    drug_conc = `DrugConc(inuM)`
  )

```


```{r lincs_cdk4_6_old_meta}
cdk_old_meta_raw <- synapser::synGet("syn21542403", followLink = TRUE) %>%
  chuck("path") %>%
  read_csv()

cdk_old_meta <- cdk_old_meta_raw %>%
  transmute(
    plate = 1,
    well,
    cells = cell_line,
    drug = recode(drug, "DMSO" = "control"),
    drug_conc = concentration__um
  )

```


```{r lincs_cdk4_6_7_new_meta}
cdk_new_meta_raw <- syn("syn21544269") %>%
  read_csv()

cdk_new_meta <- cdk_new_meta_raw %>%
  drop_na(cell_line) %>%
  transmute(
    plate,
    well,
    cells = cell_line,
    drug  = recode(agent, "DMSO" = "control"),
    drug_conc = concentration
  )

```


```{r ld_dub_meta}
ld_dub_raw <- synapser::synGet("syn21542711", followLink = TRUE) %>%
  chuck("path") %>%
  read_tsv()

ld_dub_meta <- ld_dub_raw %>%
  transmute(
    plate = 1,
    well,
    cells = cellline,
    drug = recode(
      agent,
      "DMSO" = "control",
      "CGM097" = "CHEMBL3601398"
    ),
    drug_conc = concentration,
    time
  )

```


```{r sr_repurposing_meta}
sr_repurposing_meta_raw1 <- synapser::synGet("syn21546999", followLink = TRUE) %>%
  chuck("path") %>%
  read_csv()

sr_repurposing_meta_raw2 <- synapser::synGet("syn21547000", followLink = TRUE) %>%
  chuck("path") %>%
  read_csv()
  
sr_repurposing_meta1 <- sr_repurposing_meta_raw1 %>%
  transmute(
    plate = 1,
    well = Well,
    cells = "rencell",
    drug = recode(Drug, "Drug control" = "control"),
    drug_conc = Concentration %>%
      magrittr::inset(is.na(.), 0)
  )

sr_repurposing_meta2 <- sr_repurposing_meta_raw2 %>%
  transmute(
    plate = 1,
    well = Well,
    cells = "rencell",
    drug = recode(Drug, "DMSO" = "control"),
    stim = str_match(drug, "\\((.+)\\)$") %>%
      {.[, 2]} %>%
      str_trim(),
    drug_conc = Concentration %>%
      magrittr::inset(is.na(.), 0)
  ) %>%
  mutate(
    stim = if_else(drug %in% stim, drug, stim),
    drug = str_replace_all(drug, "\\(.+\\)$", "") %>%
      str_trim() %>%
      # If drug is actually a stimulus put control
      {if_else(. == stim & !is.na(stim), "control", .)}
  )

```


```{r counts}
dataset_syn <- tribble(
  ~dataset, ~folder_syn, ~date,
  "jsm_merck", "syn21541313", "2017_09",
  "lincs_cdk4_6_7", "syn21541462", "2017_09",
  "ld_dub", "syn21541471", "2018_06",
  "lincs_cdk4_6_7", "syn21541479", "2019_08",
  "sr_repurposing", "syn21548149", "2018_02",
  "sr_repurposing", "syn21548150", "2018_11"
) %>%
  mutate(
    files = map(
      folder_syn,
      function(x) {
        folder_content = synChildren(x)
        cm_match <- str_match(names(folder_content), "^(?:(.*[0-9]+)|tagcounts)\\.mtx$")
        cm_hit <- !is.na(cm_match[, 1])
        # browser()
        if (sum(cm_hit) > 1) {
          plate_idx <- cm_match[, 2][cm_hit]
          tibble(
            plate = plate_idx,
            counts = folder_content[cm_hit],
            count_dupes = folder_content[paste0(plate_idx, "-dupes.mtx")],
            colnames = folder_content[paste0(plate_idx, ".mtx.colnames")],
            rownames = folder_content[paste0(plate_idx, ".mtx.rownames")],
            barcode_counts = folder_content[paste0(plate_idx, "-barcodes.tsv")]
          )
        } else {
          tibble(
            plate = "1",
            counts = folder_content["tagcounts.mtx"],
            count_dupes = folder_content["tagcounts-dupes.mtx"],
            colnames = folder_content["tagcounts.mtx.colnames"],
            rownames = folder_content["tagcounts.mtx.rownames"],
            barcode_counts = folder_content["cb-histogram.txt"]
          )
        }
      }
    )
  ) %>%
  unnest(files)

dataset_files <- dataset_syn %>%
  mutate_at(vars(-dataset, -folder_syn, -date), map_chr, syn)

datasets_raw <- dataset_files %>%
  mutate_at(
    vars(counts, count_dupes),
    map, prepare_mtx_sparse
  ) %>%
  mutate(
    barcode_counts = map(barcode_counts, prepare_barcode_counts, barcode_well_map) %>%
      map(
        function(x) {
          # Only keep P11 well with highest count
          # browser()
          x %>%
            mutate(well_id = str_split_fixed(well, fixed("_"), 2)[, 1]) %>%
            arrange(well_id, desc(count)) %>%
            group_by(well_id) %>%
            slice(1) %>%
            ungroup() %>%
            select(barcode, well = well_id, count)
        }
      ),
    barcode_map = map(
      barcode_counts,
      select,
      well, barcode
    ),
    colnames = map2(colnames, barcode_map, prepare_col_meta),
    rownames = map(rownames, prepare_row_meta)
  )

all_ensembl_ids <- datasets_raw %>%
  pull(rownames) %>%
  map("ensembl_gene_id") %>%
  reduce(union)

mart <- biomaRt::useMart(
  host = "http://sep2019.archive.ensembl.org",
  biomart = "ENSEMBL_MART_ENSEMBL",
  dataset = "hsapiens_gene_ensembl"
)
ensembl_gene_id_mapping_biomart <- biomaRt::select(
  mart, all_ensembl_ids,
  c("hgnc_symbol", "ensembl_gene_id", "gene_biotype"), "ensembl_gene_id"
) %>%
  as_tibble() %>%
  filter(gene_biotype == "protein_coding") %>%
  mutate(hgnc_symbol = magrittr::inset(hgnc_symbol, hgnc_symbol == "", NA_character_)) %>%
  rename(symbol = hgnc_symbol) %>%
  select(-gene_biotype) %>%
  # keep only a single symbol per ensembl_gene_id
  group_by(ensembl_gene_id) %>%
  slice(1) %>%
  ungroup()

# There are some spurios barcodes that don't map to any well
# get rid of them with drop_na
datasets_counts <- datasets_raw %>%
  transmute(
    dataset,
    plate,
    date,
    counts = pmap(
      list(counts, colnames, rownames),
      prepare_counts,
      ensembl_gene_id_mapping_biomart
    ) %>%
      map(drop_na, well),
    count_dupes = pmap(
      list(count_dupes, colnames, rownames),
      prepare_counts,
      ensembl_gene_id_mapping_biomart
    ) %>%
      map(drop_na, well),
    barcode_counts = barcode_counts %>%
      map(drop_na, well)
  )
```


```{r datasets_with_meta}
meta_all <- tribble(
  ~dataset, ~meta, ~date,
  "jsm_merck", jsm_meta, "2017_09",
  "lincs_cdk4_6_7", cdk_old_meta, "2017_09",
  "ld_dub", ld_dub_meta, "2018_06",
  "lincs_cdk4_6_7", cdk_new_meta, "2019_08",
  "sr_repurposing", sr_repurposing_meta1, "2018_02",
  "sr_repurposing", sr_repurposing_meta2, "2018_11",
) %>%
  unnest(meta) %>%
  mutate(
    drug_norm = norm_drug(drug),
    plate = if_else(is.na(plate), "1", as.character(plate)),
    batch = paste(dataset, date, plate, sep = "_"),
  )

cmpd_name_map <- syn("syn21586544") %>%
  read_csv()

cmpd_name_map_norm <- cmpd_name_map %>%
  distinct(
    lspci_id,
    name,
    name_norm = norm_drug(name)
  ) %>%
  # Barasertib appears twice in Chembl (CHEMBL415049 and CHEMBL215152)
  # CHEMBL215152 is most likely a mistake
  # keeping only CHEMBL415049 (lspci_id 102882), discarding CHEMBL215152 (lspci_id 100354)
  filter(lspci_id != 100354)

cmdps_mapped <- meta_all %>%
  distinct(
    drug,
    drug_norm
  ) %>%
  left_join(
    cmpd_name_map_norm,
    by = c("drug_norm" = "name_norm")
  )

meta_cmpd_mapped <- meta_all %>%
  left_join(
    distinct(cmdps_mapped, drug_norm, lspci_id),
    by = "drug_norm"
  ) %>%
  mutate(
    # drug_id is either lspci_id or normalized drug name, if lspci_id was not found
    drug_id = if_else(!is.na(lspci_id), as.character(lspci_id), drug_norm)
  ) %>%
  mutate(
    condition = exec(
      paste,
      !!!as.list(.)[c("cells", "stim", "stim_conc", "drug_id", "drug_conc", "time")],
      sep = "_"
    ),
    sample_id = paste(batch, well, condition, sep = "_"),
    # Matching each sample with it's control condition
    # This is the sample which has the same cell line, stimulus and time point
    # and drug == "control"
    control_condition = exec(
      paste,
      !!!as.list(.)[c("cells", "stim", "stim_conc", "drug_id", "drug_conc", "time")] %>%
        magrittr::inset2("drug_id", "control") %>%
        magrittr::inset2("drug_conc", 0) %>%
        magrittr::inset2("sep", "_")
    ) %>%
      magrittr::inset(!(. %in% condition), NA_character_)
  ) %>%
  group_nest(dataset, date, plate, batch, .key = "meta")

datasets <- datasets_counts %>%
  inner_join(meta_cmpd_mapped , by = c("dataset", "date", "plate")) %>%
  mutate_at(
    vars(counts, count_dupes, barcode_counts),
    map2,
    .$meta,
    ~.x %>%
      inner_join(
        distinct(.y, well, sample_id),
        by = "well"
      )
  ) %>%
  select(-meta)


write_rds(
  datasets,
  file.path(wd, "counts_raw.rds"),
  compress = "gz"
)

write_rds(
  meta_cmpd_mapped,
  file.path(wd, "meta_mapped.rds"),
  compress = "gz"
)

dataset_names <- tribble(
  ~dataset, ~dataset_name, ~date,
  "jsm_merck", "2017_09_john_santa_maria_merck_drugs", "2017_09",
  "lincs_cdk4_6_7", "2017_09_lincs_cdk4_6_inhibitors", "2017_09",
  "ld_dub", "2018_06_laura_doherty_dub_inhibitors", "2018_06",
  "lincs_cdk4_6_7", "2019_08_lincs_cdk4_6_7_inhibitors", "2019_08",
  "sr_repurposing", "2018_02_steven_rodriguez_ad_repurposing", "2018_02",
  "sr_repurposing", "2018_11_steven_rodriguez_ad_repurposing", "2018_11",
) %>%
  mutate(
    dataset_name = as.factor(dataset_name) %>%
      fct_inorder()
  )


write_csv(
  dataset_names,
  file.path(wd, "dataset_names.csv")
)


```

```{r synapse}
activity <- synapser::Activity(
  name = "Wrangle DGE data",
  used = c(
    "syn12979100",
    "syn21541012",
    "syn21542403",
    "syn21542711",
    "syn21586544",
    dataset_syn %>%
      select(-dataset, -folder_syn, -plate, -date) %>%
      reduce(union)
  ),
  executed = "https://github.com/clemenshug/dge_comparison/blob/master/wrangling/09_dge_datasets.Rmd"
)

c(
  file.path(wd, "counts_raw.rds"),
  file.path(wd, "dataset_names.csv"),
  file.path(wd, "meta_mapped.rds")
) %>%
  synStoreMany(parentId = "syn21542764", activity = activity)

#rsync -rv --exclude *.fq.gz --exclude fastq --exclude *.fastq.gz --exclude *.bam --exclude rapmap --exclude transcriptome 2018_02_steven_rodriguez_ad_repurposing transfer:/n/files/ImStor/sorger/data/rnaseq/lincs/dge_reanalysis_clemens/
```

