---
title: "CMap data"
author: "Clemens Hug"
date: "3/19/2019"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(cmapR)
library(webchem)
library(synExtra)
library(here)
library(lspcheminf)
library(furrr)

synapser::synLogin()
syn <- synExtra::synDownloader("~/data/DGE_comp/")
```


```{r compound_info}
compound_dict <- syn("syn21094266") %>%
  read_csv()

```


## CMap data

There are two big CMap datasets, Phase I and II with two different GEO accession
numbers. Loading metadata and Z-score matrix from both.


```{r perturbation_meta}
pertubation_meta_raw <- list(
  GSE92742 = "ftp://ftp.ncbi.nlm.nih.gov/geo/series/GSE92nnn/GSE92742/suppl/GSE92742_Broad_LINCS_pert_info.txt.gz",
  GSE70138 = "ftp://ftp.ncbi.nlm.nih.gov/geo/series/GSE70nnn/GSE70138/suppl/GSE70138_Broad_LINCS_pert_info_2017-03-06.txt.gz"
) %>%
  map(read_tsv, na = "-666") %>%
  bind_rows(.id = "dataset")

unique_compounds <- pertubation_meta_raw %>%
  drop_na(canonical_smiles) %>%
  distinct(pert_id, smiles = canonical_smiles) %>%
  left_join(
    convert_compound_identifier(
      set_names(.$smiles, .$pert_id),
      identifier = "smiles",
      target_identifier = "inchi"
    ) %>%
      select(inchi = compounds, pert_id = names),
    by = "pert_id"
  )

plan(multisession(workers = 4))
unique_compounds_canonical <- unique_compounds %>%
  distinct(pert_id, inchi) %>%
  drop_na() %>%
  chunk_df(12) %>%
  future_map(
    ~left_join(
      .x,
      canonicalize_compound(
        set_names(.x$inchi, .x$pert_id),
        standardize = TRUE
      ) %>%
        select(pert_id = compound, canonical_inchi = inchi),
      by = "pert_id"
    ),
    .progress = TRUE
  ) %>%
  bind_rows()

compound_dict_chunks <- compound_dict %>%
  drop_na(inchi) %>%
  select(lspci_id, inchi) %>%
  chunk_df(10) %>%
  enframe("chunk_id", "data")

compound_lspci_id_mapping <- compound_dict_chunks %>%
  crossing(fingerprint_type = c("morgan", "topological")) %>%
  mutate(
    data = future_map2(
      data, fingerprint_type,
      ~chemical_similarity_threshold(
        unique_compounds_canonical %>%
          drop_na(canonical_inchi) %>%
          distinct(pert_id, canonical_inchi) %>%
          {set_names(.$canonical_inchi, .$pert_id)},
        .x %>%
          {set_names(.$inchi, .$lspci_id)},
          # head(100000),
        threshold = 1,
        fingerprint_type = .y,
        url = "http://192.168.56.101:8000"
      ),
      .progress = TRUE
    )
  )

# compound_dict_mw <- compound_dict_chunks %>%
#  mutate(
#    mw = future_map(
#      data,
#      ~lspcheminf::molecular_mass(
#        set_names(.x$inchi, .x$lspci_id)
#      ),
#      .progress = TRUE
#    )
#  )


compound_lspci_id_mapping_df <- compound_lspci_id_mapping %>%
  select(data, fingerprint_type) %>%
  unnest(data) %>%
  group_by(query) %>%
  filter(
    n() == 2,
    all(c("morgan", "topological") %in% fingerprint_type),
    length(unique(target)) == 1
  ) %>%
  ungroup() %>%
  distinct(pert_id = query, lspci_id = target)


write_csv(
  compound_lspci_id_mapping_df,
  here("wrangled", "cmap_pertubation_compound_mapping.csv")
)

pertubation_meta <- pertubation_meta_raw %>%
  mutate(
    pert_iname_norm = str_replace_all(pert_iname, "[^a-zA-Z\\d]", "") %>% str_to_lower()
  ) %>%
  left_join(
    compound_lspci_id_mapping_df,
    by = "pert_id"
  )
  # left_join(pubchem_ids, by = "inchi_key") %>%
  # # Some compounds in the original dataset already have pubchem ids, merging
  # # them with the fetched ones
  # mutate(
  #   pubchem_cid = map2(
  #     pubchem_cid.x, pubchem_cid.y,
  #     ~unique(c(.x, .y)) %>%
  #       # Remove NA values if there is a non-NA value
  #       {if (sum(!is.na(.)) > 0) na.omit(.) else .}
  #   )
  # ) %>%
  # select(-pubchem_cid.x, -pubchem_cid.y) %>%
  # unnest(pubchem_cid)

# pertubation_meta %>% filter(!is.na(lspci_id))

write_csv(pertubation_meta, here("wrangled", "cmap_perturbation_meta.csv.gz"))
```



```{r instance_meta}
instance_meta_raw <- list(
  GSE92742 = "ftp://ftp.ncbi.nlm.nih.gov/geo/series/GSE92nnn/GSE92742/suppl/GSE92742_Broad_LINCS_inst_info.txt.gz",
  GSE70138 = "ftp://ftp.ncbi.nlm.nih.gov/geo/series/GSE70nnn/GSE70138/suppl/GSE70138_Broad_LINCS_inst_info_2017-03-06.txt.gz"
) %>%
  map(read_tsv, na = "-666") %>%
  bind_rows(.id = "dataset")

instance_meta <- instance_meta_raw %>%
  left_join(select(pertubation_meta, pert_id, pubchem_cid, lspci_id), by = "pert_id")

write_csv(instance_meta, file.path("..", "wrangled", "cmap_instance_meta.csv.gz"))
```




```{r signature_meta}
signature_meta_raw <- list(
  GSE92742 = "ftp://ftp.ncbi.nlm.nih.gov/geo/series/GSE92nnn/GSE92742/suppl/GSE92742_Broad_LINCS_sig_info.txt.gz",
  GSE70138 = "ftp://ftp.ncbi.nlm.nih.gov/geo/series/GSE70nnn/GSE70138/suppl/GSE70138_Broad_LINCS_sig_info_2017-03-06.txt.gz"
) %>%
  map(read_tsv, na = c("-666", "-666.00")) %>%
  bind_rows(.id = "dataset")
# Parsing failures correspond to malformed fields in input data, are in irrelevant
# signatures, so ignore...

signature_meta <- signature_meta_raw %>%
  mutate(
    pert_dose = if_else(is.na(pert_dose), as.double(str_match(pert_idose, "([\\d\\.]+) um")[, 2]), pert_dose) %>%
      {if_else(. < 0, NA_real_, .)},
    pert_dose_unit = if_else(str_detect(pert_idose, "([\\d\\.]+) um"), "ÂµM", pert_dose_unit),
    pert_time = if_else(is.na(pert_time), as.double(str_match(pert_itime, "([\\d]+) h")[, 2]), pert_time),
    pert_time_unit = if_else(is.na(pert_itime), NA_character_, "h")
  ) %>%
  left_join(select(pertubation_meta, pert_id, lspci_id), by = "pert_id")

write_csv(signature_meta, file.path("..", "wrangled", "cmap_signature_meta.csv.gz"))
```


```{r gene_meta}
gene_meta_raw <- list(
  GSE92742 = "ftp://ftp.ncbi.nlm.nih.gov/geo/series/GSE92nnn/GSE92742/suppl/GSE92742_Broad_LINCS_gene_info.txt.gz",
  GSE70138 = "ftp://ftp.ncbi.nlm.nih.gov/geo/series/GSE70nnn/GSE70138/suppl/GSE70138_Broad_LINCS_gene_info_2017-03-06.txt.gz"
) %>%
  map(read_tsv, na = "-666") %>%
  bind_rows(.id = "dataset")

# Check if the two datasets are identical
gene_meta_identical <- gene_meta_raw %>%
  group_by_at(vars(-dataset)) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  dplyr::count(n)
# They are!

gene_meta <- gene_meta_raw %>%
  filter(dataset == "GSE92742") %>%
  genebabel::join_hgnc("pr_gene_symbol", c("symbol", "alias_symbol", "prev_symbol"), "symbol") %>%
  select(-dataset)

write_csv(gene_meta, file.path("..", "wrangled", "cmap_gene_meta.csv.gz"))
```

Gene metadata for both datasets are identical, can save just a single one.

```{r synapse}
activity <- synapser::Activity(
  name = "Wrangle CMap data",
  used = c(
    "ftp://ftp.ncbi.nlm.nih.gov/geo/series/GSE92nnn/GSE92742/suppl/GSE92742_Broad_LINCS_pert_info.txt.gz",
    "ftp://ftp.ncbi.nlm.nih.gov/geo/series/GSE70nnn/GSE70138/suppl/GSE70138_Broad_LINCS_pert_info_2017-03-06.txt.gz",
    "ftp://ftp.ncbi.nlm.nih.gov/geo/series/GSE92nnn/GSE92742/suppl/GSE92742_Broad_LINCS_inst_info.txt.gz",
    "ftp://ftp.ncbi.nlm.nih.gov/geo/series/GSE70nnn/GSE70138/suppl/GSE70138_Broad_LINCS_inst_info_2017-03-06.txt.gz",
    "ftp://ftp.ncbi.nlm.nih.gov/geo/series/GSE92nnn/GSE92742/suppl/GSE92742_Broad_LINCS_sig_info.txt.gz",
    "ftp://ftp.ncbi.nlm.nih.gov/geo/series/GSE70nnn/GSE70138/suppl/GSE70138_Broad_LINCS_sig_info_2017-03-06.txt.gz",
    "ftp://ftp.ncbi.nlm.nih.gov/geo/series/GSE92nnn/GSE92742/suppl/GSE92742_Broad_LINCS_gene_info.txt.gz",
    "ftp://ftp.ncbi.nlm.nih.gov/geo/series/GSE70nnn/GSE70138/suppl/GSE70138_Broad_LINCS_gene_info_2017-03-06.txt.gz"
  ),
  executed = "https://github.com/clemenshug/dge_comparison/blob/master/wrangling/05_cmap_data.Rmd"
)

c(
  here("wrangled", "cmap_perturbation_meta.csv.gz"),
  here("wrangled", "cmap_instance_meta.csv.gz"),
  here("wrangled", "cmap_signature_meta.csv.gz"),
  here("wrangled", "cmap_gene_meta.csv.gz")
) %>%
  synStoreMany(parentId = "syn21547022", activity = activity)

#rsync -rv --exclude *.fq.gz --exclude fastq --exclude *.fastq.gz --exclude *.bam --exclude rapmap --exclude transcriptome 2018_02_steven_rodriguez_ad_repurposing transfer:/n/files/ImStor/sorger/data/rnaseq/lincs/dge_reanalysis_clemens/
```


