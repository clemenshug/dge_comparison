---
title: "DESeq2 drug treatments vs control"
author: "Clemens Hug"
date: "3/15/2019"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(here)
library(synExtra)

synapser::synLogin()
syn <- synDownloader(here("data"))

paste_ <- function(...) {
  paste(..., sep = "_")
}
```

Calculating differentially expressed genes between drug treatment conditions
and control for DGE.

```{r read_data}
deseq_input <- syn("syn21558154") %>%
  read_rds()

```




```{r deseq_drugs_vs_control}
wd <- here("deseq", "treatment_vs_control")
dir.create(wd)

chunked_deseq_input <- deseq_input %>%
  lspcheminf::chunk_df(100, seed = 1) %>%
  enframe(name = "chunk", value = "data") %>%
  mutate(
    input_file = file.path(wd, paste0("deseq_input_", chunk, ".rds")),
    output_file = file.path(wd, paste0("deseq_result_", chunk, ".rds"))
  ) %>%
  # Have to get rid of some spurious samples where there is only control and some
  # other controls, eg. LPS
  rowwise() %>%
  mutate(
    data = data %>%
      filter(map_lgl(samples, ~!all(.x[["drug_conc"]] == 0))) %>%
      list()
  )

pwalk(
  chunked_deseq_input,
  function(data, input_file, ...) {
    write_rds(
      data,
      input_file,
      compress = "gz"
    )
  }
)

process_deseq <- function(input, output) {
  library(tidyverse)
  unloadNamespace("synapser")
  unloadNamespace("PythonEmbedInR")
  
  run_deseq_comp <- function(meta_deseq, counts_deseq, design, ...) {
    attr(design, ".Environment") <- baseenv()
    de <- DESeq2::DESeqDataSetFromMatrix(
      counts_deseq %>%
        {.[, order(colnames(.))]},
      meta_deseq %>%
        {.[order(rownames(.)), ]},
      design = design
    ) %>%
      DESeq2::DESeq()
    name <- DESeq2::resultsNames(de)[[2]]
    res <- DESeq2::results(de, name = name, alpha = 0.05)
    shrunk <- DESeq2::lfcShrink(de, coef = name, res = res, type = "apeglm")
    out_res <- as.data.frame(shrunk) %>%
      rownames_to_column("ensembl_gene_id") %>%
      as_tibble() %>%
      left_join(
        as.data.frame(res) %>%
          rownames_to_column("ensembl_gene_id") %>%
          select(ensembl_gene_id, log2FoldChange_MLE = log2FoldChange),
        by = "ensembl_gene_id"
      )
    list(
      deseq_object = de,
      results = out_res
    )
  }
  deseq_input <- read_rds(input)
  res <- pmap(deseq_input, run_deseq_comp)
  write_rds(
    res %>%
      map("results"),
    output,
    compress = "gz"
  )
}

library(batchtools)

reg <- makeRegistry(
  file.dir = file.path(wd, paste0("registry_", gsub(" ", "_", Sys.time()))),
  seed = 1
)
# reg <- loadRegistry()

batchMap(
  fun = process_deseq,
  input = chunked_deseq_input[["input_file"]],
  output = chunked_deseq_input[["output_file"]]
)

job_table <- findJobs() %>%
  # Chunk jobs into a single array job
  mutate(chunk = 1)


submitJobs(
  job_table,
  resources = list(
    memory = "10gb",
    ncpus = 1L,
    partition = "short",
    walltime = 30*60,
    chunks.as.arrayjobs = TRUE,
    # For some reason these nodes fail to execute R because of an "illegal instruction"
    exclude = "compute-f-17-[09-25]"
  )
)

deseq_results <- chunked_deseq_input %>%
  ungroup() %>%
  mutate(
    data = map2(
      data, output_file,
      # ~.x[["results"]] <- read_rds(.y)
      function(data, output_file) {
        x <- read_rds(output_file)
        if (nrow(data) != length(x))
          browser()
        data[["results"]] <- x
        data
      }
    )
  ) %>%
  pull(data) %>%
  bind_rows()


write_rds(
  deseq_results,
  here("deseq", "deseq_treatment_vs_control.rds"),
  compress = "gz"
)

```


```{r synapse}
activity <- synapser::Activity(
  name = "Run DESeq2",
  used = c(
    "syn21558154"
  ),
  executed = "https://github.com/clemenshug/dge_comparison/blob/master/02_deseq2_drug_treatment_vs_control.Rmd"
)

c(
  here("deseq", "deseq_treatment_vs_control.rds")
) %>%
  synStoreMany(parentId = "syn21558153", activity = activity)

#rsync -rv --exclude *.fq.gz --exclude fastq --exclude *.fastq.gz --exclude *.bam --exclude rapmap --exclude transcriptome 2018_02_steven_rodriguez_ad_repurposing transfer:/n/files/ImStor/sorger/data/rnaseq/lincs/dge_reanalysis_clemens/
```

