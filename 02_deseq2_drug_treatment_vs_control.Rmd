---
title: "DESeq2 drug treatments vs control"
author: "Clemens Hug"
date: "3/15/2019"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(DESeq2)
library(VennDiagram)
library(UpSetR)
library(here)
library(furrr)

synapser::synLogin()
syn <- synExtra::synDownloader("~/data/DGE_comp/")

paste_ <- function(...) {
  paste(..., sep = "_")
}
```

Calculating differentially expressed genes between drug treatment conditions
and control for DGE and bulk RNA-seq separately.

```{r read_data}
deseq_input <- syn("syn21558154") %>%
  read_rds()
```


Checking which conditions have a complete set of samples, with at least 2 replicates.
Removing singleton samples without replicate.


```{r building_deseq_meta}
MIN_N <- 2L

match_samples <- function(meta) {
  samples <- meta %>%
    filter(condition != control_condition) %>%
    mutate(treatment = "treatment") %>%
    group_nest(condition, control_condition, .key = "samples")
  controls <- meta %>%
    filter(condition == control_condition) %>%
    mutate(treatment = "control") %>%
    select(-condition) %>%
    group_nest(control_condition, .key = "controls")
  samples %>%
    left_join(controls, by = "control_condition") %>%
    filter(map2_lgl(samples, controls, ~nrow(.x) > MIN_N & nrow(.y) > MIN_N)) %>%
    mutate(
      deseq_meta = map2(
        samples, controls,
        bind_rows
      ) %>%
        map(
          ~.x %>%
            column_to_rownames("sample_id")
        ),
      condition_df = map(
        samples,
        select_if,
        ~length(unique(.x)) == 1
      ) %>%
        map(distinct)
    ) %>%
    unnest(condition_df)
}


comps_meta <- deseq_input %>%
  transmute(
    dataset,
    batch = paste(batch, plate, sep = "_"),
    meta
  ) %>%
  unnest(meta) %>%
  group_nest(dataset, .key = "meta") %>%
  transmute(
    dataset,
    samples = map(meta, match_samples)
  )

```






```{r deseq_drugs_vs_control}
dataset_counts <- deseq_input %>%
  select(dataset, counts) %>%
  group_by(dataset) %>%
  summarize(counts = list(bind_rows(counts))) %>%
  ungroup() %>%
  {set_names(.$counts, .$dataset)}

# Adding count matrices for each condition
comps_inputs <- comps_meta %>%
  unnest(samples) %>%
  select(-samples, -controls) %>%
  mutate(
    counts_deseq = map2(
      deseq_meta, dataset,
      ~dataset_counts[[.y]] %>%
        filter(sample_id %in% rownames(.x)) %>%
        dplyr::select(ensembl_gene_id, sample_id, count) %>%
        # filter(sample_id %in% rownames(meta_deseq)) %>%
        spread(sample_id, count) %>%
        mutate_at(vars(-ensembl_gene_id), replace_na, replace = 0) %>%
        column_to_rownames("ensembl_gene_id") %>%
        as.matrix()
    )
  )

run_deseq_comp <- function(deseq_meta, counts_deseq, ...) {
  design <- if (length(unique(deseq_meta[["batch"]])) > 1) ~treatment + batch else ~treatment
  library(tidyverse)
  suppressMessages(
    DESeq2::DESeqDataSetFromMatrix(
      counts_deseq %>%
        {.[, order(colnames(.))]},
      deseq_meta %>%
        {.[order(rownames(.)), ]},
      design = design
    )
  )
}

comp_deseqs <- comps_inputs %>%
  # dplyr::rename(meta = deseq_meta) %>%
  mutate(
    deseq = pmap(
      .,
      run_deseq_comp
    )
  )

plan(multisession(workers = 4))
comp_deseqs_calc <- comp_deseqs %>%
  # dplyr::rename(meta = deseq_meta) %>%
  mutate(
    deseq = future_map(
      deseq,
      DESeq,
      .progress = TRUE
    )
  )


write_rds(comp_deseqs_calc, here("deseq", "deseq_treatment_vs_control.rds"))
# comp_deseqs_calc <- read_rds(here("deseq", "deseq_treatment_vs_control.rds"))

unloadNamespace("synapser")
unloadNamespace("PythonEmbedInR")


comp_res <- comp_deseqs_calc %>%
  mutate(
    result = map(
      deseq,
      function(d) {
        name <- "treatment_treatment_vs_control"
        res <- results(d, name = name, alpha = 0.05)
        shrunk <- lfcShrink(d, coef = name, res = res, type = "apeglm")
        as.data.frame(shrunk) %>%
          rownames_to_column("ensembl_gene_id") %>%
          as_tibble() %>%
          left_join(
            as.data.frame(res) %>%
              rownames_to_column("ensembl_gene_id") %>%
              select(ensembl_gene_id, log2FoldChange_MLE = log2FoldChange),
            by = "ensembl_gene_id"
          )
      }
    )
  )

# comp_res_df <- comp_res %>%
#   select(name, method, cell_line, drug, concentration, time, result)
write_rds(
  comp_res,
  here("deseq", "deseq_treatment_vs_control_result.rds"),
  compress = "gz"
)

```

# Using linear model with log transformed concentration

```{r deseq_drug_vs_control_log_model}
MIN_N_CONC <- 2L

match_samples_conc_model <- function(meta) {
  condition_vars <- meta %>%
    group_by(condition) %>%
    group_map(
      function(x, ...) {
        x %>%
          select_if(~length(unique(.x)) == 1) %>%
          select(-drug_conc) %>%
          colnames()
      }
    ) %>%
    purrr::reduce(intersect)
  meta_conc <- meta %>%
    mutate(
      condition_conc = as.list(.)[condition_vars] %>%
        magrittr::inset("sep", "_") %>%
        {do.call(paste, .)}
    )
  samples <- meta_conc %>%
    filter(condition != control_condition) %>%
    group_nest(condition_conc, control_condition, .key = "samples")
  controls <- meta %>%
    filter(condition == control_condition) %>%
    select(-condition) %>%
    group_nest(control_condition, .key = "controls")
  samples %>%
    left_join(controls, by = "control_condition") %>%
    filter(
      map2_lgl(samples, controls, ~length(unique(.x[["drug_conc"]])) >= MIN_N_CONC  & nrow(.y) >= MIN_N)
    ) %>%
    mutate(
      deseq_meta = map2(
        samples, controls,
        bind_rows
      ) %>%
        map(
          ~.x %>%
            mutate(conc_rank = as.double(as.integer(factor(drug_conc, levels = sort(unique(drug_conc))))) - 1) %>%
            column_to_rownames("sample_id")
        ),
      condition_df = map(
        samples,
        select_if,
        ~length(unique(.x)) == 1
      ) %>%
        map(distinct)
    ) %>%
    unnest(condition_df)
}


comps_meta_conc <- deseq_input %>%
  transmute(
    dataset,
    batch = paste(batch, plate, sep = "_"),
    meta
  ) %>%
  unnest(meta) %>%
  group_nest(dataset, .key = "meta") %>%
  transmute(
    dataset,
    samples = map(meta, match_samples_conc_model)
  )


# Adding count matrices for each condition
comps_inputs_conc <- comps_meta_conc %>%
  unnest(samples) %>%
  select(-samples, -controls) %>%
  mutate(
    counts_deseq = map2(
      deseq_meta, dataset,
      ~dataset_counts[[.y]] %>%
        filter(sample_id %in% rownames(.x)) %>%
        dplyr::select(ensembl_gene_id, sample_id, count) %>%
        # filter(sample_id %in% rownames(meta_deseq)) %>%
        spread(sample_id, count) %>%
        mutate_at(vars(-ensembl_gene_id), replace_na, replace = 0) %>%
        column_to_rownames("ensembl_gene_id") %>%
        as.matrix()
    )
  )


run_deseq_comp_conc <- function(deseq_meta, counts_deseq, ...) {
  design <- if (length(unique(deseq_meta[["batch"]])) > 1) ~conc_rank + batch else ~conc_rank
  library(tidyverse)
  suppressMessages(
    DESeq2::DESeqDataSetFromMatrix(
      counts_deseq %>%
        {.[, order(colnames(.))]},
      deseq_meta %>%
        {.[order(rownames(.)), ]},
      design = design
    )
  )
}

comp_deseqs_conc <- comps_inputs_conc %>%
  # dplyr::rename(meta = deseq_meta) %>%
  mutate(
    deseq = pmap(
      .,
      run_deseq_comp_conc
    )
  )

comp_deseqs_conc_calc <- comp_deseqs_conc %>%
  # dplyr::rename(meta = deseq_meta) %>%
  mutate(
    deseq = map(
      deseq,
      DESeq
    )
  )


write_rds(comp_deseqs_conc_calc, here("deseq", "deseq_treatment_vs_control_conc.rds"))
# comp_deseqs_conc_calc <- read_rds(here("deseq", "deseq_treatment_vs_control_conc.rds"))

unloadNamespace("synapser")
unloadNamespace("PythonEmbedInR")

# plan(multisession(workers = 4))
# options(future.globals.maxSize = 1500 * 1024**2)
comp_res_conc <- comp_deseqs_conc_calc %>%
  mutate(
    result = map(
      deseq,
      function(d) {
        name <- "conc_rank"
        res <- results(d, name = name, alpha = 0.05)
        shrunk <- lfcShrink(d, coef = name, res = res, type = "apeglm")
        as.data.frame(shrunk) %>%
          rownames_to_column("ensembl_gene_id") %>%
          as_tibble() %>%
          left_join(
            as.data.frame(res) %>%
              rownames_to_column("ensembl_gene_id") %>%
              select(ensembl_gene_id, log2FoldChange_MLE = log2FoldChange),
            by = "ensembl_gene_id"
          )
      }
    )
  )

# comp_res_df <- comp_res %>%
#   select(name, method, cell_line, drug, concentration, time, result)
write_rds(
  comp_res_conc,
  here("deseq", "deseq_treatment_vs_control_conc_result.rds"),
  compress = "gz"
)


```



```{r synapse}
activity <- synapser::Activity(
  name = "Run DESeq2",
  used = c(
    "syn21558154"
  ),
  executed = "https://github.com/clemenshug/dge_comparison/blob/master/02_deseq2_drug_treatment_vs_control.Rmd"
)

c(
  here("deseq", "deseq_treatment_vs_control_result.rds"),
  here("deseq", "deseq_treatment_vs_control_conc_result.rds")
) %>%
  synStoreMany(parentId = "syn21558153", activity = activity)

#rsync -rv --exclude *.fq.gz --exclude fastq --exclude *.fastq.gz --exclude *.bam --exclude rapmap --exclude transcriptome 2018_02_steven_rodriguez_ad_repurposing transfer:/n/files/ImStor/sorger/data/rnaseq/lincs/dge_reanalysis_clemens/
```

